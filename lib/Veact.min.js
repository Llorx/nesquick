"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VeactState=void 0,function(e){e.IS_PROXY=Symbol("IS_PROXY"),e.GET_VALUE=Symbol("GET_VALUE");let t=null,n=new WeakMap,i=null,s=new Set,l=new Set;function r(e){e.animated=!1,e.oldProps=new Set(e.props),e.prerunning=t,t=e,e.cb(),t=e.prerunning,e.prerunning=null;for(let t of e.oldProps)t.cbs.delete(e),e.props.delete(t),0===t.cbs.size&&t.proxified.delete(t.prop)}function o(){for(let e of s)s.delete(e),r(e);for(let e of l)l.delete(e),e();s.size>0?o():i=null}function a(e){e.paused?e.dirty=!0:e.animated||(e.animated=!0,s.add(e),null===i&&(i=requestAnimationFrame(o)))}function d(e){e.animated=!1,s.delete(e),0==s.size&&(cancelAnimationFrame(i),i=null)}e.disableSub=function(){let e=t;return t=null,e},e.enableSub=function(e){t=e},e.pause=function(e){e.paused=!0,e.animated&&(e.dirty=!0,d(e))},e.resume=function(e){e.paused=!1,e.dirty&&(e.dirty=!1,a(e))},e.draw=function(e){!function(e){l.add(e),null===i&&(i=requestAnimationFrame(o))}(e)},e.render=function(e){let t=n.get(e);return t||n.set(e,t={oldProps:new Set,props:new Set,animated:!1,cb:e,prerunning:null,paused:!1,dirty:!1}),a(t),t},e.cancel=function(e){e.animated&&d(e);for(let t of e.props)t.cbs.delete(e)};const h=new WeakMap;function c(t){return t&&t[e.IS_PROXY]?t[e.GET_VALUE]:t}function p(n){if(n&&"object"==typeof n&&!n[e.IS_PROXY]){let i=h.get(n);if(i)n=i;else{let i=new Map,s=n;n=new Proxy(n,{get:(n,l)=>{if(l===e.IS_PROXY)return!0;if(l===e.GET_VALUE)return s;{let e=i.get(l);if(e)e.dirty&&(e.dirty=!1,e.value=p(e.value));else{let t=n[l];i.set(l,e={proxified:i,value:p(t),realValue:c(t),dirty:!1,cbs:new Set,prop:l})}return t&&!t.oldProps.delete(e)&&(e.cbs.add(t),t.props.add(e)),e.value}},set:(t,n,s)=>{let l=i.get(n);if(l){let i=s&&s[e.IS_PROXY],r=i?s[e.GET_VALUE]:s;if(l.realValue!==r){t[n]=r,l.realValue=r,l.value=s,i||(l.dirty=!0);for(let e of l.cbs)a(e)}}else t[n]=s;return!0}}),h.set(s,n)}}return n}e.proxy=function(e){return h.get(e)||e},e.value=c,Object.defineProperties(Function.prototype,{val:{value(){let e=this();return e?e.val():e},enumerable:!1}}),Object.defineProperties(Object.prototype,{val:{value(){return this},enumerable:!1}}),e.stateNoOptions=p,e.state=function(e,t){return p(e)}}(exports.VeactState||(exports.VeactState={})),exports.Veact=void 0,function(e){const t=new WeakMap;e.createElement=function(e,t,...i){if("string"==typeof e)return new n(t,i,e);if(e.prototype instanceof n)return new e(t,i);{let s=new n(t,i);return s.render=e,s}};class n{props;children;type;static for(e,n){let i=[];return t.set(i,{constructor:this,callback:e,options:n||{},children:[],keys:n&&n.key?new Map:null}),i}subs=new Set;displaySub=null;childrenElements=new Set;visible=!0;parent=null;destroyed=!1;parentVisible=!0;_content=null;onremove=null;state=null;constructor(e,t=[],n){this.props=e,this.children=t,this.type=n}draw(e){let t=exports.VeactState.render(e);this.subs.add(t)}drawDisplay(e){this.displaySub=exports.VeactState.render(e)}onRemove(){this.remove()}remove(){if(this._content&&this._content.parentNode&&this._content.parentNode.removeChild(this._content),this.onremove)for(let e of this.onremove)e.removed()}removed(){}unsubscribe(e=[]){this.displaySub&&exports.VeactState.cancel(this.displaySub);for(let e of this.subs)exports.VeactState.cancel(e);for(let t of this.childrenElements)t.unsubscribe(e);return this.removed&&e.push(this),e}appendTo(e){return e.append(this.node),this}valueOf(){return this.node}onRender(){}get node(){if(!this._content){this.state&&(this.state=exports.VeactState.state(this.state));let e=exports.VeactState.disableSub(),t=this.render(this.props);t&&(this.childrenElements.add(t),t.parent=this,this._content=t.node),exports.VeactState.enableSub(e),this.onRender&&this.onRender()}return this._content}pause(){for(let e of this.subs)exports.VeactState.pause(e)}resume(){for(let e of this.subs)exports.VeactState.resume(e)}pauseDisplay(){this.displaySub&&exports.VeactState.pause(this.displaySub)}resumeDisplay(){this.displaySub&&exports.VeactState.resume(this.displaySub)}setParentVisible(e){if(this.parentVisible!==e&&(this.parentVisible=e,e?(this.resumeDisplay(),this.visible&&this.resume()):(this.visible&&this.pause(),this.pauseDisplay()),this.visible))for(let t of this.childrenElements)t.setParentVisible(e)}setVisible(e){this.visible=e,this.parentVisible&&(e?this.resume():this.pause());for(let t of this.childrenElements)t.setParentVisible(e)}setStyle(e,t){for(let[n,i]of Object.entries(t))i instanceof Function?"display"===n?this.drawDisplay(((t,n)=>{let i=n();e[t]=i;let s="none"===i;this.visible===s&&this.setVisible(!s)}).bind(this,n,i)):this.draw(((t,n)=>{e[t]=n()}).bind(this,n,i)):e[n]=i}render(e){let t=document.createElement(this.type);if(this._content=t,this.props)for(let[e,n]of Object.entries(this.props))if(Array.isArray(n)){let i=[],s=[];for(let e=0;e<n.length;e++){let t=n[e];"function"==typeof t?s.push({i:e,cb:t}):i.push(t)}s.length?this.draw((n=>{for(let e of n)i[e.i]=e.cb();t.setAttribute(e,t[e]=i.join(""))}).bind(this,s)):t.setAttribute(e,t[e]=i.join(""))}else"function"==typeof n?e.startsWith("on")&&e.charCodeAt(2)>=65&&e.charCodeAt(2)<=90?t.addEventListener(e.substring(2).toLowerCase(),n):this.draw(((e,n)=>{let i=t[e]=n();"string"==typeof i&&t.setAttribute(e,i)}).bind(this,e,n)):"style"===e?this.setStyle(t.style,n):(t[e]=n,"string"==typeof n&&t.setAttribute(e,n));return this.appendChilds(this.children),null}createDynamicChild(e,t){let n={data:e,i:null,element:new t.constructor(t.options&&"props"in t.options?t.options.props(e):e,[])};return this.childrenElements.add(n.element),n.element.parent=this,n}insertDynamicChild(e,t,n,i,s){let l=t&&t.children[n+1];if(l)this._content.insertBefore(e,l.element._content);else{let t=null;for(let e=s+1;e<i.length&&!t;e++)t=i[e].node;t?this._content.insertBefore(e,t):this._content.appendChild(e)}}removeChild(e){this.childrenElements.delete(e)}destroy(){this.destroyed||(this.destroyed=!0,this.onremove=this.unsubscribe(),this.parent&&this.parent.removeChild(this),this.onRemove())}appendChilds(e){let i=[];for(let s=0;s<e.length;s++){let l=e[s];if(l instanceof Function){let e={node:null};i[s]=e,((t,n)=>{let s;this.draw((()=>{let l=t();s?s.nodeValue=l:(s=document.createTextNode(l),e.node=s,this.insertDynamicChild(s,null,0,i,n))}))})(l,s)}else if(Array.isArray(l)){let e=t.get(exports.VeactState.value(l));if(e){let t={node:null};i[s]=t,((e,n,s)=>{this.draw((()=>{let l=n.callback();Array.isArray(l)||(l=l?[l]:[]);let r=n.options.key;if(r){let t=n.keys,o=new Map(t);for(let e=0;e<l.length;e++){let a,d=l[e],h=r(d);o.delete(h)||(a=this.createDynamicChild(d,n),n.children.push(a),t.set(h,a),this.insertDynamicChild(a.element.node,n,n.children.length,i,s))}for(let[e,n]of o){t.delete(e),n.element.destroy(),n.element=null}for(let t=0;t<n.children.length;t++){let i=n.children[t];i.element?null===i.i&&(e.splice(t,0,i.element),i.i=t):(e.splice(t,1),n.children.splice(t--,1))}}else{for(let t=0;t<l.length;t++){let r=l[t],o=n.children[t];o?o.data!==r&&(o.element.destroy(),o.data=r,o.element=new n.constructor(n.options&&"props"in n.options?n.options.props(r):r,[]),e[t]=o.element,this.childrenElements.add(o.element),o.element.parent=this,this.insertDynamicChild(o.element.node,n,t,i,s)):(o=this.createDynamicChild(r,n),e[t]=o.element,n.children[t]=o,this.insertDynamicChild(o.element.node,n,t,i,s))}if(l.length<n.children.length){for(let e=l.length;e<n.children.length;e++){n.children[e].element.destroy()}n.children.splice(l.length),e.splice(l.length)}}t.node=n.children.length>0?n.children[0].element._content:null}))})(l,e,s)}else i[s]=this.appendChilds(l)}else if(l instanceof n)if(l.destroyed)i[s]={node:null};else{this.childrenElements.add(l),l.parent=this;let e=l.node;i[s]={node:e},this._content.appendChild(e)}else null!=l&&(l instanceof Node||(l=document.createTextNode(String(l))),i[s]={node:l},this._content.appendChild(l))}return i[0]}}e.VeactElement=n}(exports.Veact||(exports.Veact={}));
